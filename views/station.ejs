<%- layout('layouts/boilerplate') %>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css' rel='stylesheet' />
<link rel="stylesheet" type="text/css" href="/css/stars.css">

<%function shareholdersAndRestrictionsList (array){%>
    <%for(let i of array){%>
        <%if (array === currentStation.restrictions) {%>
            <li class="card-text"><%=i%></li>
            <%} else { %>
                <span class="card-text text-muted"><%=i%>,</span>
            <%}%>
        <%}%>
    <%}%>  

<!-- In-House CSS -->
<style>
body{
    background: url(<%=currentStation.images[0].url%>);
    background-size: cover;
    color:aliceblue;
}
</style>


<main id="main">
    <div class="row">  
        <div class="card col-sm-12 col-lg-7" id="stationCard">
            
            <div id="stationImageSlider" class="carousel slide" data-interval="false" data-ride="carousel">
                <div class="carousel-inner">
                    <% for( let image of currentStation.images) { %>     
                  <div class="carousel-item active">
                    <img class="card-img-top d-block img-fluid" src="<%=image.url%>" alt="First slide">
                  </div>
                  <% } %>
                </div>
    
                <a class="carousel-control-prev" href="#stationImageSlider" role="button" data-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#stationImageSlider" role="button" data-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="sr-only">Next</span>
                </a>
            </div>

            <div class="card-body">
            <a href="/station/<%=currentStation.id%>"><h2 class="card-title"><%=currentStation.name%></h2></a>
            <p id="description" class="card-text"><%=currentStation.description%></p>
            <h4 class="card-text"><%=currentStation.geometry.location[0]%>, <%=currentStation.geometry.location[1]%>, <%=currentStation.zipcode%></h4>
            <hr>
            <div class="square d-flex">

                <% for( let admin of admins) { %>
                    <% if (admin.username === currentStation.owner) { %>
                        <img src="<%=admin.profilePic.url%>" height=100 width=auto class="d-block">
                        <%break;%>
                    <% } %>
                <% } %>
    
                <h3 id="stationOwner" class="card-text">Created by: <%=currentStation.owner%></h3>
                </div>
            
            <hr>
            <h6>Restrictions/Requirements to Enter:</h6>
            <%= shareholdersAndRestrictionsList(currentStation.restrictions);%>
            <hr>
            <h6>Current stockowners/shareholders of Station property:</h6>
            <%= shareholdersAndRestrictionsList(currentStation.shareholders);%>
            <hr>
    
    <!-- ================================================== -->
    <!-- For each Station listed, we check if there are reviews. If so: -->
    <!-- ================================================== -->

            
                <div class="d-flex justify-content-between p-2">
                <a href="/review/new/<%=currentStation.id%>" class="btn btn-info" role="button">Post Review</a>

    <!-- If you're a User and your name equals the Station owner (or you're an Admin), you can delete the Station -->
                <% if (registeredUser && registeredUser.username == currentStation.owner || registeredAdmin) { %>
                    <a href="/station/<%=currentStation.name%>/<%=currentStation.id%>" class="btn btn-primary" role="button">Edit Station</a>
                    <form action="/station/<%=currentStation.id%>?_method=DELETE" class="form" method="POST">
                        <button class="btn btn-danger" role="button">Delete Station</button>
                    </form>
                <% } %>
                </div>

            </div>
        </div>


    <div class="col-sm-12 col-md-12 col-lg-5">

        <div id='map' class="mx-5" style='width: auto; height: 700px;' ></div>

        <div class="p-3 m-3" id="mapFooter">
            <p>Heretic is a dark fantasy first-person shooter video game released in 1994. It was developed by Raven Software and published by id Software through GT Interactive. The game was released on Steam on August 3, 2007.[2]
            Using a modified version of the Doom engine, Heretic was one of the first first-person games to feature inventory manipulation and the ability to look up and down. It alsointroduced multiple gib objects that spawned when a character suffered a death by extreme force or heat. Previously, the character would simply crumple into a heap. The gameused randomised ambient sounds and noises, such as evil laughter, chains rattling, distantly ringing bells, and water dripping in addition to the background music to furtherenhance the atmosphere. The music in the game was composed by Kevin Schilder. An indirect sequel, Hexen: Beyond Heretic, was released the following year. Heretic II was releasedin 1998, which served as a direct sequel continuing the story.</p>
        </div>
    </div>
</div>

</main>

<!-- ======================================================================
End of Top Page: Reviews are below
======================================================================= -->


<section class="row d-flex justify-content-center">

    <% if (currentStation.reviews) { %>

<!-- #1: If there are any reviews, then we list each one through "stationReview", and find the creater of that review 
using our populate/path methods from Mongoose -->
    <% for( let stationReview of currentStation.reviews) { %>

        <%let currentReviewer%>
        <% if (stationReview.admin && stationReview.admin.length) { %>
            <%currentReviewer = stationReview.admin[0]%>
        <% } %>

        <% if (stationReview.user && stationReview.user.length) {%>
            <%currentReviewer = stationReview.user[0]%>
        <% } %> 
            
<div class="card col-sm-12 col-md-9 col-lg-5 p-3 m-3" id="reviewBox">

<!-- These next 2 codeblocks are the same, except one just checks if you're a User, the other if you're an Administrator. If either, you can delete the given review  -->
<div class="row">

<!-- Everything about the review itself. The crap above is authorization checks to see if you can delete/edit -->  
        <div class="col-sm-12"> 
            <h4 class="my-3"><%=stationReview.statement%></h4>
            <p class="starability-result" data-rating="<%=stationReview.rating%>"></p>  
            <% if (currentReviewer.admin) { %>
                <h4 id="adminReview"><%=currentReviewer.username%></h4>
            <% } else {%>
                <h4 id="userReview"><%=currentReviewer.username%></h4>
            <% }  %>
        </div>

        <% if (registeredUser) { %>
            <% if (stationReview.user[0] && registeredUser.id === currentReviewer.id){ %>
                <div class="col-sm-4"> 
                    <form action="/review/<%=stationReview.id%>?_method=DELETE" class="form" method="POST">
                        <div class="form-group">
                            <button class="btn btn-sm btn-danger">Delete</button>
                            <a class="btn btn-sm btn-info" id="editReview">Edit</a>
                        </div>
                    </form>
                </div>
            <% } %> 
        <% } %>

        <% if (registeredAdmin) { %>
            <% if (stationReview.admin[0] && registeredAdmin.id === currentReviewer.id){ %>
                <div class="col-sm-4"> 
                    <form action="/review/<%=stationReview.id%>?_method=DELETE" class="form" method="POST">
                        <div class="form-group">
                            <button class="btn btn-sm btn-danger">Delete</button>
                            <a class="btn btn-sm btn-info" id="editReview">Edit</a>
                        </div>
                    </form>
                </div>
            <% } %> 
        <% } %>         
    </div>                    
    <p class="card-text" id="reviewText"><%=stationReview.content%></p>
    <hr>

<!-- If there were any images posted by the User, store them (but hide them) unless selected to display by the browsing User -->                           
            <% if (stationReview.images && stationReview.images.length) { %>

                    <h5><%=currentReviewer.username%> posted images below</h5>


                <form action="/station/<%=currentStation.name%>/<%=stationReview.id%>?_method=PUT" class="form-inline row d-flex justify-content-center" method="POST">
                    <!-- For editing/removing images from the current station. We use "userImage" class and the station's ID for interaction through the DOM -->
                <div class="container" id="reviewImages">
                <% for (let image of stationReview.images) { %>
                    <img src="<%=image.thumbnail%>" class="userImage hide img-thumbnail" id="<%=stationReview.id%>" alt="">
                    <input type="checkbox" class="checkbox" name="deleteImages[]" value="<%=image.filename%>">
                <% } %>
             
                <% if (registeredUser) { %>
                    <% if (stationReview.user[0] && registeredUser.id === stationReview.user[0].id){ %>
                        <button class="btn btn-warning hide userImage" id="<%=stationReview.id%>">Remove Images</button>
                    <% } %> 
                <% } %>
                <% if (registeredAdmin) { %>
                    <% if (stationReview.admin[0] && registeredAdmin.id === currentReviewer.id){ %>
                        <button class="btn btn-warning hide userImage" id="<%=stationReview.id%>">Remove Images</button>
                    <% } %> 
                <% } %>
            </div>  
  
                </form>
                <button class="btn btn-primary showImages" id="<%=stationReview.id%>">Show Images</button>
            <% } %>

            </div>

<!-- This displays a new form, and hides all other reviews IF the User clicks Edit Review -->
<form id="editReviewForm" action="/review/edit/<%=stationReview.id%>?_method=PUT" class="form container hide" method="POST" enctype="multipart/form-data">
    <% if (registeredAdmin && registeredAdmin.length) { %>
        <input type="text" class="form-control hide" name="admin" value="<%=registeredAdmin.id%>">
        <% } else if (registeredUser && registeredUser.length){%>
        <input type="text" class="form-control hide" name="user" value="<%=registeredUser.id%>">
        <% } %>
        
    <div class="form-group">
        <label for="statement">Blanket statement goes here</label>
        <input type="text" name="statement" class="form-control">
    </div>      
    
    <div class="form-group">
        <label for="images">Put your worthless opinion below</label>
        <input type="file" name="images" class="form-control" multiple>
    </div>                
    
    <div class="form-group">
        <label for="rating">Terrible to Great?</label>
    <fieldset class="starability-basic">
        <legend>First rating:</legend>
        <input type="radio" id="no-rate" class="input-no-rate" name="rating" value="0" checked aria-label="No rating." />
        <input type="radio" id="first-rate1" name="rating" value="1" />
        <label for="first-rate1" title="Terrible">1 star</label>
        <input type="radio" id="first-rate2" name="rating" value="2" />
        <label for="first-rate2" title="Not good">2 stars</label>
        <input type="radio" id="first-rate3" name="rating" value="3" />
        <label for="first-rate3" title="Average">3 stars</label>
        <input type="radio" id="first-rate4" name="rating" value="4" />
        <label for="first-rate4" title="Good">4 stars</label>
        <input type="radio" id="first-rate5" name="rating" value="5" />
        <label for="first-rate5" title="Amazing">5 stars</label>
      </fieldset>
    </div>
    
    <div class="form-group">
        <label for="content">Put your worthless opinion below</label>
        <textarea class="form-control" type="range" cols="30" rows="10" name="content" id="content"><%=stationReview.content%></textarea>
    </div>

    <input type="text" name="station" class="hide" value="<%=currentStation._id%>">
    <div class="row justify-content-center">
        <button class="col-sm-5 btn btn-success form-control m-3">Adjust Review</button>
        <a class="col-sm-5 btn btn-primary form-control m-3" id="nevermind">Nevermind</a>
    </div>
</form>    

    <% } %>
<% } %>

</section>

<!-- In-House CSS -->
<style>
    .hide{
        display:none;
    }
    main{
        background: white;
        border: 3px solid black;
        color: black;
        /* display: inline-block; */

        font-size: 1.1rem;
        display: flex;
        padding: 1%;
        margin: 2%;
    } 
    .carousel-item img{
        max-width: 920px;
        height: 600px;
    }
    #map{
        border: 2px solid black;
        box-shadow: 12px 18px 24px black;
    } #mapFooter {
        border: 4px solid grey;
    }

/* Review Boxes */
    section{
        color:black;
    }
    #reviewBox{
        transition: 800ms;
        border:5px solid grey;
        box-shadow: 12px 18px 24px black;
    }
    #userReview{
        font-family: Black Ops One;
        color:green;
    }
    #adminReview{
        font-family: Black Ops One;
        color:mediumblue;
    }
    #editReviewForm{
        border: 3px solid black;
        background: rgba(20, 20, 20, 0.8);
        color:azure;

        padding: 10%;
    }  
</style>


<!-- In-House Javascript -->
<script>
    const reviewBox = document.querySelector('#reviewBox');
    const editReviewForm = document.querySelector('#editReviewForm');
    const editReview = document.querySelector('#editReview');
    const nevermind = document.querySelector('#nevermind');
    const showImages = document.getElementsByClassName('showImages');

    // Map
    mapboxgl.accessToken = '<%=process.env.MAPBOX_TOKEN%>';
    const long = '<%=currentStation.geometry.coordinates[0]%>';
    const lat = '<%=currentStation.geometry.coordinates[1]%>';
    var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10', // stylesheet location
    center: [long, lat], // starting position [lng, lat]
    zoom: 9 // starting zoom
    });
    var marker = new mapboxgl.Marker()
    .setLngLat([long, lat])
    .setPopup(new mapboxgl.Popup({offset: 25})
    .setHTML(`<h6><%=currentStation.name%><h6>`))
    .addTo(map);  
    // <END OF> Map

if(document.querySelector('#editReview')){

    editReview.addEventListener('click', (e) =>{

        reviewBox.classList.add('hide');
        editReviewForm.classList.remove('hide');
    })

    nevermind.addEventListener('click', (e) =>{

        reviewBox.classList.remove('hide');
        editReviewForm.classList.add('hide');
    })
}

    function imageDisplay (e) {
        /*   THIS refers to the button element being clicked. The button will have the ID of the User who posted the given Review and its Images*/

        /*We declare these dumb variables with Array.from so we can use Array methods (filter and includes).*/
        const allUserImages = document.getElementsByClassName('userImage');
        const forFucksSake = Array.from(allUserImages);

        /*allUserImages is every single Image posted between every review. Every single image has the ID of the belonging User's ID, as does the Button we just clicked, so...*/
        const imagesToHide = forFucksSake.filter( (div) => div.id === this.id)

        for(let image of imagesToHide){
            let imageClasses = Array.from(image.classList);

            /*Every image stored will now be hidden -- unless it is already hidden: Whereas we do the opposite. Change button text to be consistent with operation*/
            if (imageClasses.includes('hide')) {
                image.classList.remove('hide');
                this.innerText = 'Hide Images';

            } else {    
                image.classList.add('hide');
                this.innerText = 'Show Images';
            }
        }
    }

    for (let button of showImages){
        button.addEventListener('click', imageDisplay)
    }

</script>